<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Banco Validaci√≥n - Solicitud de Tarjeta de Cr√©dito</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./css/styles.css">
    <style>
    </style>
</head>
<body>
    <div class="banco-header">
        <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Banco Logo" class="logo"/>
        <h1>Banco Validaci√≥n</h1>
        <div class="bandera">
            <div class="franja azul"></div>
            <div class="franja blanco"></div>
            <div class="franja rojo"></div>
            <div class="franja blanco"></div>
            <div class="franja azul"></div>
        </div>
        <div class="sub">Solicita tu tarjeta de cr√©dito en minutos</div>
    </div>

    <div class="nav" >
        <a href="./pruebas-automaticas" class="button">üß™ Ver Pruebas Autom√°ticas</a>
        <a href="./reporte-pruebas" class="button">üìä Ver Reportes</a>
        <button onclick="mostrarGuiaChat()" class="button guide-button">ü§ñ Gu√≠a con Chat IA</button>
        <button onclick="ejecutarPruebasExhaustivas()" class="button ai-test-button">üî¨ Pruebas IA Exhaustivas</button>
        <button onclick="ejecutarPruebas()" class="button test-button">‚ö° Ejecutar Pruebas</button>
    </div>

    <!-- Modal para Pruebas Exhaustivas -->
    <div id="pruebasModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ü§ñ IA Ejecutando Pruebas Exhaustivas</h3>
            </div>
            <div class="modal-body">
                <div class="ai-analysis-progress">
                    <div class="progress-spinner"></div>
                    <p id="progress-text">Iniciando an√°lisis de seguridad...</p>
                    <div class="progress-details">
                        <small id="progress-detail">Preparando entorno de pruebas...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Gu√≠a de Chat IA -->
    <div id="guiaModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ü§ñ Asistente Virtual BCR</h3>
                <span class="close" onclick="cerrarGuiaChat()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="chatGuia" class="chat-guia">
                    <div class="message bot">
                        <p>¬°Hola! Soy tu asistente virtual del Banco de Costa Rica. ¬øEn qu√© puedo ayudarte?</p>
                        <small>Puedes preguntarme sobre:</small>
                        <ul>
                            <li>C√≥mo llenar el formulario de solicitud</li>
                            <li>Requisitos para tarjetas de cr√©dito</li>
                            <li>Documentos necesarios</li>
                            <li>Proceso de validaci√≥n</li>
                        </ul>
                    </div>
                </div>
                <form id="guiaForm" class="guia-form">
                    <input type="text" id="guiaInput" placeholder="Escribe tu pregunta..." autocomplete="off" required />
                    <button type="submit">Enviar</button>
                </form>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="tarjeta-demo">
            <div class="chip"></div>
            <div class="info">
                <span>Tarjeta de Cr√©dito</span>
                <strong>Banco Validaci√≥n</strong>
            </div>
            <img src="https://cdn-icons-png.flaticon.com/512/196/196578.png" alt="Visa" width="38"/>
        </div>
        <div class="chat" id="chat"></div>
        <form id="chatForm">
            <input type="text" id="input" placeholder="Escribe tu respuesta..." autocomplete="off" required />
            <button type="submit">Enviar</button>
        </form>
        <div id="estado-tarjeta" class="estado-tarjeta"></div>
    </div>
    <div class="footer">
        &copy; 2025 Banco Validaci√≥n. Todos los derechos reservados.
    </div>
    <div style="text-align:center; margin-top:24px;">
        <button onclick="ejecutarPruebas()" style="background:#1565c0;color:#fff;padding:10px 20px;border:none;border-radius:6px;margin:5px;cursor:pointer;">
            Ejecutar Pruebas Autom√°ticas
        </button>
        <button onclick="verRecomendaciones()" style="background:#ce1126;color:#fff;padding:10px 20px;border:none;border-radius:6px;margin:5px;cursor:pointer;">
            Ver Recomendaciones
        </button>
        <div id="resultados-pruebas" style="margin-top:18px; color:#222; font-size:1.05em;"></div>
    </div>    <script src="./js/chat.js"></script>
    <script>
        // Sistema de Gu√≠a de Chat IA
        let guiaChat = null;
        
        function mostrarGuiaChat() {
            document.getElementById('guiaModal').style.display = 'block';
            if (!guiaChat) {
                guiaChat = new GuiaChatIA();
            }
        }
        
        function cerrarGuiaChat() {
            document.getElementById('guiaModal').style.display = 'none';
        }
        
        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modal = document.getElementById('guiaModal');
            if (event.target === modal) {
                cerrarGuiaChat();
            }
        }
        
        class GuiaChatIA {
            constructor() {
                this.chatContainer = document.getElementById('chatGuia');
                this.form = document.getElementById('guiaForm');
                this.input = document.getElementById('guiaInput');
                this.responses = this.getKnowledgeBase();
                
                this.init();
            }
            
            init() {
                this.form.addEventListener('submit', (e) => this.handleGuiaSubmit(e));
            }
            
            async handleGuiaSubmit(e) {
                e.preventDefault();
                const message = this.input.value.trim();
                if (!message) return;
                
                this.addGuiaMessage(message, 'user');
                this.input.value = '';
                
                // Mostrar indicador de escritura
                this.addGuiaMessage('El asistente est√° escribiendo...', 'bot typing');
                
                try {
                    const response = await fetch('/chat-guia', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: message })
                    });
                    
                    const data = await response.json();
                    
                    // Remover indicador de escritura
                    const typingMessages = this.chatContainer.querySelectorAll('.typing');
                    typingMessages.forEach(msg => msg.remove());
                    
                    this.addGuiaMessage(data.response, 'bot');
                } catch (error) {
                    // Remover indicador de escritura
                    const typingMessages = this.chatContainer.querySelectorAll('.typing');
                    typingMessages.forEach(msg => msg.remove());
                    
                    this.addGuiaMessage('Lo siento, hubo un error. Por favor intenta de nuevo.', 'bot');
                }
            }
            
            addGuiaMessage(text, type) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                messageDiv.innerHTML = `<p>${text}</p>`;
                this.chatContainer.appendChild(messageDiv);
                this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
            }
            
            getKnowledgeBase() {
                return {
                    'formulario': 'Para llenar el formulario correctamente: 1) Ingresa tu nombre completo (1-2 nombres + 2 apellidos), 2) Tu c√©dula de 9-10 d√≠gitos, 3) Tel√©fono de 8 d√≠gitos empezando con 2,6,7 u 8, 4) Direcci√≥n completa para entrega.',
                    'requisitos': 'Requisitos para tarjeta BCR: Mayor de edad, c√©dula vigente, ingresos demostrables m√≠nimos ‚Ç°300,000, no estar en centrales de riesgo, residir en Costa Rica.',
                    'documentos': 'Documentos necesarios: C√©dula de identidad vigente, comprobante de ingresos (colillas, constancia patronal), comprobante de domicilio (recibo de servicios).',
                    'validacion': 'El proceso de validaci√≥n incluye: verificaci√≥n en CCSS, consulta en centrales de riesgo, validaci√≥n en sistema BCR, y confirmaci√≥n en Ministerio de Hacienda.',
                    'tiempo': 'El proceso toma aproximadamente 2-3 minutos. La tarjeta se entrega en 24-48 horas h√°biles una vez aprobada.',
                    'credito': 'El l√≠mite de cr√©dito inicial es de ‚Ç°500,000 a ‚Ç°2,000,000 dependiendo de tus ingresos y historial crediticio.',
                    'ayuda': 'Si necesitas ayuda adicional, puedes contactar al 2295-9595 o visitar cualquier sucursal BCR.'
                };
            }
            
            getAIResponse(message) {
                const lowerMessage = message.toLowerCase();
                
                // Buscar palabras clave en el mensaje
                for (const [key, response] of Object.entries(this.responses)) {
                    if (lowerMessage.includes(key) || 
                        (key === 'formulario' && (lowerMessage.includes('llenar') || lowerMessage.includes('completar'))) ||
                        (key === 'requisitos' && lowerMessage.includes('requisito')) ||
                        (key === 'documentos' && lowerMessage.includes('documento')) ||
                        (key === 'validacion' && (lowerMessage.includes('valida') || lowerMessage.includes('proceso'))) ||
                        (key === 'tiempo' && (lowerMessage.includes('tiempo') || lowerMessage.includes('demora') || lowerMessage.includes('cuanto'))) ||
                        (key === 'credito' && (lowerMessage.includes('limite') || lowerMessage.includes('monto'))) ||
                        (key === 'ayuda' && (lowerMessage.includes('contacto') || lowerMessage.includes('telefono')))) {
                        return response;
                    }
                }
                
                // Respuestas inteligentes basadas en contexto
                if (lowerMessage.includes('hola') || lowerMessage.includes('buenos')) {
                    return '¬°Hola! Soy tu asistente virtual del BCR. ¬øEn qu√© puedo ayudarte con tu solicitud de tarjeta de cr√©dito?';
                }
                
                if (lowerMessage.includes('gracias')) {
                    return '¬°De nada! Estoy aqu√≠ para ayudarte. ¬øTienes alguna otra pregunta sobre el proceso?';
                }
                
                if (lowerMessage.includes('problema') || lowerMessage.includes('error')) {
                    return 'Si tienes problemas t√©cnicos, intenta refrescar la p√°gina. Si el problema persiste, contacta al 2295-9595.';
                }
                
                // Respuesta por defecto con sugerencias
                return 'No estoy seguro de c√≥mo ayudarte con eso espec√≠ficamente. ¬øPodr√≠as preguntarme sobre: formulario, requisitos, documentos, validaci√≥n, tiempo de proceso, o l√≠mites de cr√©dito?';
            }
        }

        // Funciones adicionales para compatibilidad
        function ejecutarPruebas() {
            // Mostrar modal de progreso
            mostrarModalPruebas();
            
            fetch('/test-automated')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('resultados-pruebas').innerHTML = `
                        <div class="test-results">
                            <h4>‚úÖ Resultados de Pruebas Autom√°ticas:</h4>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <span class="stat-number">${data.total_tests}</span>
                                    <span class="stat-label">Total</span>
                                </div>
                                <div class="stat-card success">
                                    <span class="stat-number">${data.passed}</span>
                                    <span class="stat-label">Exitosas</span>
                                </div>
                                <div class="stat-card error">
                                    <span class="stat-number">${data.failed}</span>
                                    <span class="stat-label">Fallidas</span>
                                </div>
                            </div>
                            <button onclick="openTestWindow()" class="result-button">
                                üìä Ver Detalles Completos
                            </button>
                            <button onclick="ejecutarPruebasExhaustivas()" class="result-button" style="background: linear-gradient(135deg, #ff9800, #ffb74d);">
                                üî¨ Pruebas Exhaustivas con IA
                            </button>
                        </div>
                    `;
                    ocultarModalPruebas();
                })
                .catch(error => {
                    console.error('Error ejecutando pruebas:', error);
                    ocultarModalPruebas();
                });
        }

        async function ejecutarPruebasExhaustivas() {
            mostrarModalPruebas();
            
            try {
                const response = await fetch('/test-exhaustive', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                document.getElementById('resultados-pruebas').innerHTML = `
                    <div class="exhaustive-results">
                        <h4>üî¨ An√°lisis Exhaustivo con IA</h4>
                        <div class="analysis-summary">
                            <div class="metric">
                                <span class="metric-label">Escenarios Probados:</span>
                                <span class="metric-value">${data.total_scenarios}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Vulnerabilidades:</span>
                                <span class="metric-value ${data.vulnerabilities > 0 ? 'error' : 'success'}">${data.vulnerabilities}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Score de Seguridad:</span>
                                <span class="metric-value ${data.security_score < 80 ? 'warning' : 'success'}">${data.security_score}%</span>
                            </div>
                        </div>
                        <div class="recommendations-ai">
                            <h5>ü§ñ Recomendaciones de la IA:</h5>
                            <ul>
                                ${data.ai_recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="error-scenarios">
                            <h5>‚ö†Ô∏è Escenarios de Error Detectados:</h5>
                            <ul>
                                ${data.error_scenarios.map(scenario => `<li><strong>${scenario.type}:</strong> ${scenario.description}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error en pruebas exhaustivas:', error);
                document.getElementById('resultados-pruebas').innerHTML = `
                    <div class="error-message">
                        <h4>‚ùå Error en Pruebas Exhaustivas</h4>
                        <p>No se pudieron ejecutar las pruebas exhaustivas. Verifica la conexi√≥n.</p>
                    </div>
                `;
            }
            
            ocultarModalPruebas();
        }

        function mostrarModalPruebas() {
            const modal = document.createElement('div');
            modal.id = 'modalPruebas';
            modal.innerHTML = `
                <div class="modal" style="display: block;">
                    <div class="modal-content" style="text-align: center; max-width: 400px;">
                        <div class="loading-animation">
                            <div class="spinner"></div>
                            <h3>üî¨ Ejecutando Pruebas...</h3>
                            <p>La IA est√° analizando todos los escenarios posibles</p>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" id="progressFill"></div>
                            </div>
                            <p id="statusText">Iniciando an√°lisis...</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Simular progreso
            let progress = 0;
            const statusTexts = [
                "Validando campos de entrada...",
                "Probando inyecci√≥n SQL...",
                "Verificando XSS...",
                "Analizando validaciones...",
                "Probando casos l√≠mite...",
                "Generando reporte final..."
            ];
            
            const interval = setInterval(() => {
                progress += Math.random() * 20;
                if (progress > 100) progress = 100;
                
                document.getElementById('progressFill').style.width = progress + '%';
                
                const statusIndex = Math.floor((progress / 100) * statusTexts.length);
                if (statusIndex < statusTexts.length) {
                    document.getElementById('statusText').textContent = statusTexts[statusIndex];
                }
                
                if (progress >= 100) {
                    clearInterval(interval);
                }
            }, 500);
        }

        function ocultarModalPruebas() {
            const modal = document.getElementById('modalPruebas');
            if (modal) {
                modal.remove();
            }
        }

        function verRecomendaciones() {
            fetch('/recommendations')
                .then(response => response.json())
                .then(data => {
                    let html = '<div class="recommendations"><h4>üí° Recomendaciones del Sistema:</h4>';
                    data.recommendations.forEach(category => {
                        html += `<div class="rec-category">
                            <h5>${category.category}:</h5>
                            <ul>`;
                        category.items.forEach(item => {
                            html += `<li>‚úì ${item}</li>`;
                        });
                        html += '</ul></div>';
                    });
                    html += '</div>';
                    document.getElementById('resultados-pruebas').innerHTML = html;
                })
                .catch(error => {
                    console.error('Error obteniendo recomendaciones:', error);
                });
        }
        
        function openTestWindow() {
            window.open('/pruebas-automaticas', '_blank', 'width=500,height=700');
        }
        
        function openReportWindow() {
            window.open('/reporte-pruebas', '_blank', 'width=500,height=700');
        }
    </script>
</body>
</html>
